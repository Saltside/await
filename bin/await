#!/usr/bin/env bash

set -euo pipefail

await() {
	local retries="${1}" counter=0
	shift 2

	while [ "${counter}" -lt "${retries}" ]; do
		if "$@"; then
			echo "OK!"
			return 0
		else
			((counter++))
		fi
	done

	echo "failed with ${counter} retry(s)." 1>&2
	return 1
}

main() {
	local retries=60

	while getopts ":r:" opt; do
		case "${opt}" in
			r)
				retries="${OPTARG}"
				;;
			\?)
				echo "Invalid option: -${OPTARG}" 1>&2
				return 1
				;;
			:)
				echo "Option -${OPTARG} requires an argument." 1>&2
				return 1
				;;
		esac
	done

	shift $((OPTIND-1))

	local uri="${1:-}"
	shift

	case "${uri}" in
		http://*|https://*)
			await "${retries}" -- curl -s --fail "$@" "${uri}"
			;;
		mongodb://*)
			await "${retries}" -- mongo_check "$@" "${uri}"
			;;
		redis://*)
			await "${retries}" -- redis_check "$@" "${uri}"
			;;
		dynamodb://*)
			await "${retries}" -- dynamodb_check "$@" "${uri}"
			;;
		mysql://*)
			await "${retries}" -- mysql_check "$@" "${uri}"
			;;
		memcached://*)
			await "${retries}" -- memcached_check "$@" "${uri}"
			;;
		*)
			echo "Unknown resource." 1>&2
			echo "Usage: " 1>&2
			# TODO: to be filled later
			return 1
	esac
}

main "$@"
